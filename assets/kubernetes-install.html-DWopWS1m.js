import{_ as s,c as a,o as n,f as l}from"./app-BfCDUtKQ.js";const i="/assets/2023-12-04-15-48-55-Di1nPTd8.png",e={},o=l(`<h1 id="" tabindex="-1"><a class="header-anchor" href="#"><span></span></a></h1><h2 id="前置准备" tabindex="-1"><a class="header-anchor" href="#前置准备"><span>前置准备</span></a></h2><ol><li>CentOS * 3</li><li>网络策略互通</li><li>互联网访问开通</li><li>节点唯一主机名、mac</li></ol><h3 id="yum-配置" tabindex="-1"><a class="header-anchor" href="#yum-配置"><span>yum 配置</span></a></h3><p>yum</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">curl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -o</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/yum.repos.d/Centos-7.repo</span><span style="color:#98C379;--shiki-dark:#98C379;"> http://mirrors.aliyun.com/repo/Centos-7.repo</span></span></code></pre></div><p>docker</p><blockquote><p>k8s依赖容器运行时,v1.24 弃用 dockershim,可直接使用使用containerd</p></blockquote><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">curl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -o</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/yum.repos.d/docker-ce.repo</span><span style="color:#98C379;--shiki-dark:#98C379;"> http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span></code></pre></div><p>kubernetes</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &lt;&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">/etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">[kubernetes]</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">name=Kubernetes</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">enabled=1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">gpgcheck=0</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">repo_gpgcheck=0</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span></span></code></pre></div><p>yum 缓存</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">yum</span><span style="color:#98C379;--shiki-dark:#98C379;"> clean</span><span style="color:#98C379;--shiki-dark:#98C379;"> all</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">yum</span><span style="color:#98C379;--shiki-dark:#98C379;"> makecache</span></span></code></pre></div><h3 id="安装工具" tabindex="-1"><a class="header-anchor" href="#安装工具"><span>安装工具</span></a></h3><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">yum</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -y</span><span style="color:#98C379;--shiki-dark:#98C379;"> install</span><span style="color:#98C379;--shiki-dark:#98C379;"> tree</span><span style="color:#98C379;--shiki-dark:#98C379;"> vim</span><span style="color:#98C379;--shiki-dark:#98C379;"> wget</span><span style="color:#98C379;--shiki-dark:#98C379;"> bash-completion</span><span style="color:#98C379;--shiki-dark:#98C379;"> bash-completion-extras</span><span style="color:#98C379;--shiki-dark:#98C379;">  net-tools</span><span style="color:#98C379;--shiki-dark:#98C379;">  unzip</span><span style="color:#98C379;--shiki-dark:#98C379;"> nc</span><span style="color:#98C379;--shiki-dark:#98C379;"> nmap</span><span style="color:#98C379;--shiki-dark:#98C379;"> telnet</span><span style="color:#98C379;--shiki-dark:#98C379;"> ntpdate</span></span></code></pre></div><h3 id="时间设置" tabindex="-1"><a class="header-anchor" href="#时间设置"><span>时间设置</span></a></h3><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>timedatectl set-timezone Asia/Shanghai</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(echo &quot;0 01 23 * * ntpdate ntp1.aliyun.com&quot; ; crontab -l )| crontab</span></span></code></pre></div><h3 id="防火墙-swap-selinux" tabindex="-1"><a class="header-anchor" href="#防火墙-swap-selinux"><span>防火墙 swap selinux</span></a></h3><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">## 如果防火墙是running，关闭防火墙</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> systemctl</span><span style="color:#98C379;--shiki-dark:#98C379;"> disable</span><span style="color:#98C379;--shiki-dark:#98C379;"> firewalld</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">systemctl</span><span style="color:#98C379;--shiki-dark:#98C379;"> stop</span><span style="color:#98C379;--shiki-dark:#98C379;"> firewalld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 关闭SELinux </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> setenforce</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> sed</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -ri</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;s#(SELINUX=).*#\\1disabled#&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/selinux/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 关闭swap。避免 kubelet启动失败</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> swapoff</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 永久关闭swap</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> sed</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -i</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;/ swap / s/^\\(.*\\)$/#\\1/g&#39;</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/fstab</span></span></code></pre></div><h3 id="ipvs" tabindex="-1"><a class="header-anchor" href="#ipvs"><span>ipvs</span></a></h3><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 加载ipvs模块</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#98C379;--shiki-dark:#98C379;"> br_netfilter</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs_sh</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs_rr</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs_wrr</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">modprobe</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --</span><span style="color:#98C379;--shiki-dark:#98C379;"> nf_conntrack_ipv4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 验证ip_vs模块</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">lsmod</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">grep</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">ip_vs_wrr</span><span style="color:#D19A66;--shiki-dark:#D19A66;">              12697</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">ip_vs_rr</span><span style="color:#D19A66;--shiki-dark:#D19A66;">               12600</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">ip_vs_sh</span><span style="color:#D19A66;--shiki-dark:#D19A66;">               12688</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  0</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">ip_vs</span><span style="color:#D19A66;--shiki-dark:#D19A66;">                 145458</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  6</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs_rr,ip_vs_sh,ip_vs_wrr</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">nf_conntrack</span><span style="color:#D19A66;--shiki-dark:#D19A66;">          139264</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  2</span><span style="color:#98C379;--shiki-dark:#98C379;"> ip_vs,nf_conntrack_ipv4</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">libcrc32c</span><span style="color:#D19A66;--shiki-dark:#D19A66;">              12644</span><span style="color:#D19A66;--shiki-dark:#D19A66;">  3</span><span style="color:#98C379;--shiki-dark:#98C379;"> xfs,ip_vs,nf_conntrack</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 内核文件 </span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &lt;&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &gt;  </span><span style="color:#98C379;--shiki-dark:#98C379;">/etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">net.ipv4.ip_forward=1</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">vm.max_map_count=262144</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 生效并验证内核优化</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sysctl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/sysctl.d/k8s.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安装docker" tabindex="-1"><a class="header-anchor" href="#安装docker"><span>安装docker</span></a></h2><blockquote><p>或安装containerd。关注配置 /etc/containerd/config.toml</p></blockquote><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">yum</span><span style="color:#98C379;--shiki-dark:#98C379;"> install</span><span style="color:#98C379;--shiki-dark:#98C379;"> docker-ce</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -y</span></span></code></pre></div><p>配置docker</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">cat</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &lt;&lt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">/etc/docker/daemon.json</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">{</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;registry-mirrors&quot;: [</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &quot;https://registry.hub.docker.com&quot;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &quot;http://hub-mirror.c.163.com&quot;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">        &quot;https://registry.docker-cn.com&quot;</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    ],</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    # &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;data-root&quot;: &quot;/data/docker&quot;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;log-driver&quot;: &quot;json-file&quot;,</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">    &quot;log-opts&quot;: {&quot;max-size&quot;:&quot;10m&quot;, &quot;max-file&quot;:&quot;3&quot;}</span></span>
<span class="line"><span style="color:#98C379;--shiki-dark:#98C379;">} </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">EOF</span></span></code></pre></div><blockquote><p>Kubernetes 推荐使用 systemd 来替代 cgroupfs，是因为 systemd 是 Kubernetes 自带的 cgroup 管理器，负责为每个进程分配 cgroupfs，但 Docker 的 cgroup driver 默认是 cgroupfs，这样就同时运行了两个 cgroup 控制管理器。当资源有压力时，有可能会出现不稳定的情况。</p></blockquote><p>如果不修改配置，会在 kubeadm init 时提示：</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[WARNING IsDockerSystemdCheck]: detected </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;cgroupfs&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> as the Docker cgroup driver. The recommended driver is </span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;systemd&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span></span></code></pre></div><p>启动</p><div class="language-" data-ext="" data-title=""><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>systemctl start docker &amp;&amp; systemctl enable docker</span></span></code></pre></div><p>验证</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">docker</span><span style="color:#98C379;--shiki-dark:#98C379;"> run</span><span style="color:#98C379;--shiki-dark:#98C379;"> hello-world</span></span></code></pre></div><p>pause 镜像地址更换</p><blockquote><p>为了防止安装过程中出现pause镜像下载失败的问题，建议运行containerd config dump &gt; /etc/containerd/config.toml 命令，将当前配置导出到文件，并修改sandbox_image配置。</p></blockquote><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">## 修改配置文件/etc/containerd/config.toml， 更改sandbox_image配置</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[plugins]</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  [plugins.</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;io.containerd.grpc.v1.cri&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    sandbox_image</span><span style="color:#98C379;--shiki-dark:#98C379;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;registry.aliyuncs.com/google_containers/pause:3.9&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">## 如果没有/etc/containerd/config.toml文件，将默认配置导出到/etc/containerd/config.toml。</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">containerd</span><span style="color:#98C379;--shiki-dark:#98C379;"> config</span><span style="color:#98C379;--shiki-dark:#98C379;"> default</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> &gt; </span><span style="color:#98C379;--shiki-dark:#98C379;">/etc/containerd/config.toml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">## 重启containerd</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">systemctl</span><span style="color:#98C379;--shiki-dark:#98C379;"> restart</span><span style="color:#98C379;--shiki-dark:#98C379;"> containerd</span></span></code></pre></div><h2 id="安装kubeadm-kubelet-kubectl" tabindex="-1"><a class="header-anchor" href="#安装kubeadm-kubelet-kubectl"><span>安装kubeadm, kubelet, kubectl</span></a></h2><p>kubeadm：部署k8s集群的工具</p><p>kubelet: 该组件在集群中的所有机器上运行，并执行启动pod和容器之类的任务。</p><p>kubectl: 与集群通信的工具。可以只在master节点上安装</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> yum</span><span style="color:#98C379;--shiki-dark:#98C379;"> install</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -y</span><span style="color:#98C379;--shiki-dark:#98C379;"> kubelet</span><span style="color:#98C379;--shiki-dark:#98C379;"> kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> kubectl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --disableexcludes=kubernetes</span></span></code></pre></div><p>开机启动</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">systemctl</span><span style="color:#98C379;--shiki-dark:#98C379;"> enable</span><span style="color:#98C379;--shiki-dark:#98C379;"> kubelet.service</span></span></code></pre></div><h2 id="安装k8s" tabindex="-1"><a class="header-anchor" href="#安装k8s"><span>安装K8S</span></a></h2><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> init</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  --apiserver-advertise-address=192.168.2.133</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  --image-repository</span><span style="color:#98C379;--shiki-dark:#98C379;"> registry.aliyuncs.com/google_containers</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  --kubernetes-version</span><span style="color:#98C379;--shiki-dark:#98C379;"> v1.28.0</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  --service-cidr=10.96.0.0/12</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  --pod-network-cidr=10.244.0.0/16</span></span></code></pre></div><p>安装成功提示</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">To</span><span style="color:#98C379;--shiki-dark:#98C379;"> start</span><span style="color:#98C379;--shiki-dark:#98C379;"> using</span><span style="color:#98C379;--shiki-dark:#98C379;"> your</span><span style="color:#98C379;--shiki-dark:#98C379;"> cluster,</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> need</span><span style="color:#98C379;--shiki-dark:#98C379;"> to</span><span style="color:#98C379;--shiki-dark:#98C379;"> run</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> following</span><span style="color:#98C379;--shiki-dark:#98C379;"> as</span><span style="color:#98C379;--shiki-dark:#98C379;"> a</span><span style="color:#98C379;--shiki-dark:#98C379;"> regular</span><span style="color:#98C379;--shiki-dark:#98C379;"> user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> $HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> cp</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -i</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> $HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> chown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> $(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">id</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -u</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#98C379;--shiki-dark:#98C379;">:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">$(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">id</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -g</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#E06C75;--shiki-dark:#E06C75;">$HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Alternatively,</span><span style="color:#98C379;--shiki-dark:#98C379;"> if</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> are</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> root</span><span style="color:#98C379;--shiki-dark:#98C379;"> user,</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> can</span><span style="color:#98C379;--shiki-dark:#98C379;"> run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  export</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> KUBECONFIG</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">etc</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">kubernetes</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">admin</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">conf</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Then</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> can</span><span style="color:#98C379;--shiki-dark:#98C379;"> join</span><span style="color:#98C379;--shiki-dark:#98C379;"> any</span><span style="color:#98C379;--shiki-dark:#98C379;"> number</span><span style="color:#98C379;--shiki-dark:#98C379;"> of</span><span style="color:#98C379;--shiki-dark:#98C379;"> worker</span><span style="color:#98C379;--shiki-dark:#98C379;"> nodes</span><span style="color:#98C379;--shiki-dark:#98C379;"> by</span><span style="color:#98C379;--shiki-dark:#98C379;"> running</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> following</span><span style="color:#98C379;--shiki-dark:#98C379;"> on</span><span style="color:#98C379;--shiki-dark:#98C379;"> each</span><span style="color:#98C379;--shiki-dark:#98C379;"> as</span><span style="color:#98C379;--shiki-dark:#98C379;"> root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> join</span><span style="color:#98C379;--shiki-dark:#98C379;"> 192.168.2.133:6443</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --token</span><span style="color:#98C379;--shiki-dark:#98C379;"> dm4r9m.xjlx0z6e4w54uxze</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	--discovery-token-ca-cert-hash</span><span style="color:#98C379;--shiki-dark:#98C379;"> sha256:7c12c7c06ea525e6a16fc8b7f62416af11ed36d266eea348606fbbc49f6cd1f3</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]#</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据提示执行</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">To</span><span style="color:#98C379;--shiki-dark:#98C379;"> start</span><span style="color:#98C379;--shiki-dark:#98C379;"> using</span><span style="color:#98C379;--shiki-dark:#98C379;"> your</span><span style="color:#98C379;--shiki-dark:#98C379;"> cluster,</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> need</span><span style="color:#98C379;--shiki-dark:#98C379;"> to</span><span style="color:#98C379;--shiki-dark:#98C379;"> run</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> following</span><span style="color:#98C379;--shiki-dark:#98C379;"> as</span><span style="color:#98C379;--shiki-dark:#98C379;"> a</span><span style="color:#98C379;--shiki-dark:#98C379;"> regular</span><span style="color:#98C379;--shiki-dark:#98C379;"> user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  mkdir</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -p</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> $HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> cp</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -i</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> $HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  sudo</span><span style="color:#98C379;--shiki-dark:#98C379;"> chown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> $(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">id</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -u</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span><span style="color:#98C379;--shiki-dark:#98C379;">:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">$(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">id</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -g</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#E06C75;--shiki-dark:#E06C75;">$HOME</span><span style="color:#98C379;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Alternatively,</span><span style="color:#98C379;--shiki-dark:#98C379;"> if</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> are</span><span style="color:#98C379;--shiki-dark:#98C379;"> the</span><span style="color:#98C379;--shiki-dark:#98C379;"> root</span><span style="color:#98C379;--shiki-dark:#98C379;"> user,</span><span style="color:#98C379;--shiki-dark:#98C379;"> you</span><span style="color:#98C379;--shiki-dark:#98C379;"> can</span><span style="color:#98C379;--shiki-dark:#98C379;"> run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">  export</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> KUBECONFIG</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">etc</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">kubernetes</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">admin</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">conf</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">我使用的roor用户，所以执行：</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">export</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> KUBECONFIG</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">etc</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">kubernetes</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/</span><span style="color:#E06C75;--shiki-dark:#E06C75;">admin</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">conf</span></span></code></pre></div><p>节点添加, init成功后，会有此提示</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> join</span><span style="color:#98C379;--shiki-dark:#98C379;"> 192.168.2.133:6443</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --token</span><span style="color:#98C379;--shiki-dark:#98C379;"> dm4r9m.xjlx0z6e4w54uxze</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">	--discovery-token-ca-cert-hash</span><span style="color:#98C379;--shiki-dark:#98C379;"> sha256:7c12c7c06ea525e6a16fc8b7f62416af11ed36d266eea348606fbbc49f6cd1f3</span></span></code></pre></div><p>检查node, 未安装网络插件CNI，所以NotReady</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 ~]# kubectl get node -A</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">NAME</span><span style="color:#98C379;--shiki-dark:#98C379;">     STATUS</span><span style="color:#98C379;--shiki-dark:#98C379;">     ROLES</span><span style="color:#98C379;--shiki-dark:#98C379;">           AGE</span><span style="color:#98C379;--shiki-dark:#98C379;">   VERSION</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">   NotReady</span><span style="color:#98C379;--shiki-dark:#98C379;">   control-plane</span><span style="color:#98C379;--shiki-dark:#98C379;">   23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili02</span><span style="color:#98C379;--shiki-dark:#98C379;">   NotReady</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;          </span><span style="color:#98C379;--shiki-dark:#98C379;">23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili03</span><span style="color:#98C379;--shiki-dark:#98C379;">   NotReady</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;          </span><span style="color:#98C379;--shiki-dark:#98C379;">23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span></code></pre></div><h2 id="安装网络插件" tabindex="-1"><a class="header-anchor" href="#安装网络插件"><span>安装网络插件</span></a></h2><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">wget</span><span style="color:#98C379;--shiki-dark:#98C379;"> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span></code></pre></div><p>修改文件中，<code>net-conf.json.Network</code>， 与init时指定的<code>--pod-network-cidr=10.244.0.0/16</code> 一致</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">data:</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  cni-conf.json:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      &quot;name&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;cbr0&quot;,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      &quot;cniVersion&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;0.3.1&quot;,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      &quot;plugins&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">          &quot;type&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;flannel&quot;,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">          &quot;delegate&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">            &quot;hairpinMode&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> true</span><span style="color:#98C379;--shiki-dark:#98C379;">,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">            &quot;isDefaultGateway&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        },</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">          &quot;type&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;portmap&quot;,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">          &quot;capabilities&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">            &quot;portMappings&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      ]</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">  net-conf.json:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> |</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      &quot;Network&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;10.244.0.0/16&quot;,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">      &quot;Backend&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">        &quot;Type&quot;</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">:</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;vxlan&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>部署插件</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl apply -f kube-flannel.yml</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">namespace/kube-flannel</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">clusterrole.rbac.authorization.k8s.io/flannel</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">clusterrolebinding.rbac.authorization.k8s.io/flannel</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">serviceaccount/flannel</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">configmap/kube-flannel-cfg</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">daemonset.apps/kube-flannel-ds</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span></code></pre></div><p>检查</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl -n kube-system get pod -o wide</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">NAME</span><span style="color:#98C379;--shiki-dark:#98C379;">                             READY</span><span style="color:#98C379;--shiki-dark:#98C379;">   STATUS</span><span style="color:#98C379;--shiki-dark:#98C379;">    RESTARTS</span><span style="color:#98C379;--shiki-dark:#98C379;">   AGE</span><span style="color:#98C379;--shiki-dark:#98C379;">   IP</span><span style="color:#98C379;--shiki-dark:#98C379;">              NODE</span><span style="color:#98C379;--shiki-dark:#98C379;">     NOMINATED</span><span style="color:#98C379;--shiki-dark:#98C379;"> NODE</span><span style="color:#98C379;--shiki-dark:#98C379;">   READINESS</span><span style="color:#98C379;--shiki-dark:#98C379;"> GATES</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">coredns-66f779496c-hntt2</span><span style="color:#98C379;--shiki-dark:#98C379;">         1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   10.244.1.2</span><span style="color:#98C379;--shiki-dark:#98C379;">      zili02</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">coredns-66f779496c-n549l</span><span style="color:#98C379;--shiki-dark:#98C379;">         1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   10.244.1.3</span><span style="color:#98C379;--shiki-dark:#98C379;">      zili02</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">etcd-zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">                      1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.133</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-apiserver-zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">            1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.133</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-controller-manager-zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">   1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.133</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-proxy-hfjc4</span><span style="color:#98C379;--shiki-dark:#98C379;">                 1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.134</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili02</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-proxy-kpkf7</span><span style="color:#98C379;--shiki-dark:#98C379;">                 1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.135</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili03</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-proxy-xwpqj</span><span style="color:#98C379;--shiki-dark:#98C379;">                 1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   0</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.133</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-scheduler-zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">            1/1</span><span style="color:#98C379;--shiki-dark:#98C379;">     Running</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   1</span><span style="color:#98C379;--shiki-dark:#98C379;">          23h</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   192.168.2.133</span><span style="color:#98C379;--shiki-dark:#98C379;">   zili01</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;           &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl get nodes</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">NAME</span><span style="color:#98C379;--shiki-dark:#98C379;">     STATUS</span><span style="color:#98C379;--shiki-dark:#98C379;">   ROLES</span><span style="color:#98C379;--shiki-dark:#98C379;">           AGE</span><span style="color:#98C379;--shiki-dark:#98C379;">   VERSION</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili01</span><span style="color:#98C379;--shiki-dark:#98C379;">   Ready</span><span style="color:#98C379;--shiki-dark:#98C379;">    control-plane</span><span style="color:#98C379;--shiki-dark:#98C379;">   23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili02</span><span style="color:#98C379;--shiki-dark:#98C379;">   Ready</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;          </span><span style="color:#98C379;--shiki-dark:#98C379;">23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">zili03</span><span style="color:#98C379;--shiki-dark:#98C379;">   Ready</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;          </span><span style="color:#98C379;--shiki-dark:#98C379;">23h</span><span style="color:#98C379;--shiki-dark:#98C379;">   v1.28.2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl create deployment nginx </span><span style="color:#E06C75;--shiki-dark:#E06C75;">--image</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">nginx</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">deployment.apps/nginx</span><span style="color:#98C379;--shiki-dark:#98C379;"> created</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl expose deployment nginx </span><span style="color:#E06C75;--shiki-dark:#E06C75;">--port</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">80</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> --type</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">NodePort</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">service/nginx</span><span style="color:#98C379;--shiki-dark:#98C379;"> exposed</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl get svc -A</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">NAMESPACE</span><span style="color:#98C379;--shiki-dark:#98C379;">     NAME</span><span style="color:#98C379;--shiki-dark:#98C379;">         TYPE</span><span style="color:#98C379;--shiki-dark:#98C379;">        CLUSTER-IP</span><span style="color:#98C379;--shiki-dark:#98C379;">     EXTERNAL-IP</span><span style="color:#98C379;--shiki-dark:#98C379;">   PORT</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">S</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)                  </span><span style="color:#98C379;--shiki-dark:#98C379;">AGE</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">default</span><span style="color:#98C379;--shiki-dark:#98C379;">       kubernetes</span><span style="color:#98C379;--shiki-dark:#98C379;">   ClusterIP</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   10.96.0.1</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">      &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="color:#98C379;--shiki-dark:#98C379;">443/TCP</span><span style="color:#98C379;--shiki-dark:#98C379;">                  2d15h</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">default</span><span style="color:#98C379;--shiki-dark:#98C379;">       nginx</span><span style="color:#98C379;--shiki-dark:#98C379;">        NodePort</span><span style="color:#D19A66;--shiki-dark:#D19A66;">    10.96.30.102</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">   &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="color:#98C379;--shiki-dark:#98C379;">80:30892/TCP</span><span style="color:#98C379;--shiki-dark:#98C379;">             3s</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kube-system</span><span style="color:#98C379;--shiki-dark:#98C379;">   kube-dns</span><span style="color:#98C379;--shiki-dark:#98C379;">     ClusterIP</span><span style="color:#D19A66;--shiki-dark:#D19A66;">   10.96.0.10</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;        </span><span style="color:#98C379;--shiki-dark:#98C379;">53/UDP,53/TCP,9153/TCP</span><span style="color:#98C379;--shiki-dark:#98C379;">   2d15h</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问 节点地址 + 端口</p><figure><img src="`+i+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="其他" tabindex="-1"><a class="header-anchor" href="#其他"><span>其他</span></a></h2><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#生成一条永久有效的token</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> token</span><span style="color:#98C379;--shiki-dark:#98C379;"> create</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --ttl</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#查询token</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kubeadm</span><span style="color:#98C379;--shiki-dark:#98C379;"> token</span><span style="color:#98C379;--shiki-dark:#98C379;"> list</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#获取ca证书sha256编码hash值</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">openssl</span><span style="color:#98C379;--shiki-dark:#98C379;"> x509</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -pubkey</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -in</span><span style="color:#98C379;--shiki-dark:#98C379;"> /etc/kubernetes/pki/ca.crt</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">openssl</span><span style="color:#98C379;--shiki-dark:#98C379;"> rsa</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -pubin</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -outform</span><span style="color:#98C379;--shiki-dark:#98C379;"> der</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> 2&gt;</span><span style="color:#98C379;--shiki-dark:#98C379;">/dev/null</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">openssl</span><span style="color:#98C379;--shiki-dark:#98C379;"> dgst</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -sha256</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> -hex</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> | </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">sed</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;s/^.* //&#39;</span></span></code></pre></div><h3 id="污点删除" tabindex="-1"><a class="header-anchor" href="#污点删除"><span>污点删除</span></a></h3><p>查看污点</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">[root@zili01 install_k8s]# kubectl describe nodes  |</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">grep</span><span style="color:#98C379;--shiki-dark:#98C379;"> Taints</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Taints:</span><span style="color:#98C379;--shiki-dark:#98C379;">             node-role.kubernetes.io/control-plane:NoSchedule</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Taints:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">             &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">Taints:</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">             &lt;</span><span style="color:#98C379;--shiki-dark:#98C379;">non</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">e&gt;</span></span></code></pre></div><p>master节点，默认不参与调度的，可通过污点删除，让master参与调度</p><div class="language-shell" data-ext="shell" data-title="shell"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">kubectl</span><span style="color:#98C379;--shiki-dark:#98C379;"> taint</span><span style="color:#98C379;--shiki-dark:#98C379;"> nodes</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> --all</span><span style="color:#98C379;--shiki-dark:#98C379;"> node-role.kubernetes.io/control-plane-</span></span></code></pre></div><blockquote><p>不建议删除。建议master 节点配置降低，和node分开部署，各司其职</p></blockquote>`,71),r=[o];function p(k,t){return n(),a("div",null,r)}const d=s(e,[["render",p],["__file","kubernetes-install.html.vue"]]),h=JSON.parse(`{"path":"/cloud-native/kubernetes/kubernetes-install.html","title":"kubeadm安装K8S集群","lang":"zh-CN","frontmatter":{"article":true,"title":"kubeadm安装K8S集群","order":11,"category":["云原生"],"tag":["k8s","kubeadm"],"index":true,"description":"前置准备 CentOS * 3 网络策略互通 互联网访问开通 节点唯一主机名、mac yum 配置 yum docker k8s依赖容器运行时,v1.24 弃用 dockershim,可直接使用使用containerd kubernetes yum 缓存 安装工具 时间设置 防火墙 swap selinux ipvs 安装docker 或安装conta...","head":[["meta",{"property":"og:url","content":"https://docs.lizili.online/cloud-native/kubernetes/kubernetes-install.html"}],["meta",{"property":"og:site_name","content":"lzz's Blog"}],["meta",{"property":"og:title","content":"kubeadm安装K8S集群"}],["meta",{"property":"og:description","content":"前置准备 CentOS * 3 网络策略互通 互联网访问开通 节点唯一主机名、mac yum 配置 yum docker k8s依赖容器运行时,v1.24 弃用 dockershim,可直接使用使用containerd kubernetes yum 缓存 安装工具 时间设置 防火墙 swap selinux ipvs 安装docker 或安装conta..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-07T13:03:38.000Z"}],["meta",{"property":"article:author","content":"z"}],["meta",{"property":"article:tag","content":"k8s"}],["meta",{"property":"article:tag","content":"kubeadm"}],["meta",{"property":"article:modified_time","content":"2024-10-07T13:03:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"kubeadm安装K8S集群\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-07T13:03:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"z\\",\\"url\\":\\"https://docs.lizili.online\\"}]}"]]},"headers":[{"level":2,"title":"前置准备","slug":"前置准备","link":"#前置准备","children":[{"level":3,"title":"yum 配置","slug":"yum-配置","link":"#yum-配置","children":[]},{"level":3,"title":"安装工具","slug":"安装工具","link":"#安装工具","children":[]},{"level":3,"title":"时间设置","slug":"时间设置","link":"#时间设置","children":[]},{"level":3,"title":"防火墙 swap selinux","slug":"防火墙-swap-selinux","link":"#防火墙-swap-selinux","children":[]},{"level":3,"title":"ipvs","slug":"ipvs","link":"#ipvs","children":[]}]},{"level":2,"title":"安装docker","slug":"安装docker","link":"#安装docker","children":[]},{"level":2,"title":"安装kubeadm, kubelet, kubectl","slug":"安装kubeadm-kubelet-kubectl","link":"#安装kubeadm-kubelet-kubectl","children":[]},{"level":2,"title":"安装K8S","slug":"安装k8s","link":"#安装k8s","children":[]},{"level":2,"title":"安装网络插件","slug":"安装网络插件","link":"#安装网络插件","children":[]},{"level":2,"title":"其他","slug":"其他","link":"#其他","children":[{"level":3,"title":"污点删除","slug":"污点删除","link":"#污点删除","children":[]}]}],"git":{"createdTime":1701342190000,"updatedTime":1728306218000,"contributors":[{"name":"lizili","email":"cn.zili.lee@outlook.com","commits":1}]},"readingTime":{"minutes":4.59,"words":1377},"filePathRelative":"cloud-native/kubernetes/kubernetes-install.md","localizedDate":"2023年11月30日","excerpt":"\\n<h2>前置准备</h2>\\n<ol>\\n<li>CentOS * 3</li>\\n<li>网络策略互通</li>\\n<li>互联网访问开通</li>\\n<li>节点唯一主机名、mac</li>\\n</ol>\\n<h3>yum 配置</h3>\\n<p>yum</p>\\n<div class=\\"language-shell\\" data-ext=\\"shell\\" data-title=\\"shell\\"><pre class=\\"shiki shiki-themes one-dark-pro one-dark-pro vp-code\\" style=\\"background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf\\" tabindex=\\"0\\"><code><span class=\\"line\\"><span style=\\"color:#61AFEF;--shiki-dark:#61AFEF\\">curl</span><span style=\\"color:#D19A66;--shiki-dark:#D19A66\\"> -o</span><span style=\\"color:#98C379;--shiki-dark:#98C379\\"> /etc/yum.repos.d/Centos-7.repo</span><span style=\\"color:#98C379;--shiki-dark:#98C379\\"> http://mirrors.aliyun.com/repo/Centos-7.repo</span></span></code></pre>\\n</div>","autoDesc":true}`);export{d as comp,h as data};
